<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .header {
      background: #0d6efd;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .container {
      margin-top: 30px;
    }
    .form-section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .table th {
      cursor: pointer;
      user-select: none;
    }
    .table th i {
      margin-left: 8px;
      font-size: 0.8rem;
      color: #ccc;
    }
    #searchInput {
      max-width: 250px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">Student Registration</div>

  <!-- Main Container -->
  <div class="container">

    <!-- Registration Form -->
    <div class="form-section">
      <h4 class="mb-4">Register New Student</h4>
      <form>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="studentName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="studentName" placeholder="Enter full name" />
          </div>
          <div class="col-md-6">
            <label for="studentEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="studentEmail" placeholder="Enter email" />
          </div>
          <div class="col-md-6">
            <label for="studentCode" class="form-label">Student Code</label>
            <input type="text" class="form-control" id="studentCode" placeholder="Enter student code" />
          </div>
          <div class="col-md-6">
            <label for="dateCreated" class="form-label">Date Created</label>
            <input type="date" class="form-control" id="dateCreated" />
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-primary">Register</button>
          <button type="reset" class="btn btn-secondary">Clear</button>
        </div>
      </form>
    </div>

    <!-- Student Table Section -->
    <div class="form-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Student Accounts</h4>
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="Search students..."
        />
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover" id="studentTable">
          <thead class="table-dark">
            <tr>
              <th scope="col" class="sortable">Name <i class="fas fa-sort"></i></th>
              <th scope="col" class="sortable">Email <i class="fas fa-sort"></i></th>
              <th scope="col" class="sortable">Student Code <i class="fas fa-sort"></i></th>
              <th scope="col" class="sortable">Date Created <i class="fas fa-sort"></i></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>John Doe</td>
              <td>john@example.com</td>
              <td>STU123</td>
              <td>2025-08-15</td>
            </tr>
            <tr>
              <td>Jane Smith</td>
              <td>jane@example.com</td>
              <td>STU124</td>
              <td>2025-08-20</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script>
      const BASE_URL = "https://school-queue-system-backend.onrender.com";
      let tickets = [];
      let services = [];
      let summary = {};

      document.addEventListener("DOMContentLoaded", () => {
        loadAdminDashboard();
        window.setInterval(loadAdminDashboard, 15000); // Auto-refresh every 15s

        // Real-time updates via socket.io
        try {
          if (typeof io !== "undefined") {
            const socket = io(BASE_URL);
            socket.on("queueUpdate", (data) => {
              loadAdminDashboard();
              showAlert("info", "Queue updated in real-time.");
            });
            socket.on("ticketUpdate", (data) => {
              loadAdminDashboard();
              showAlert("info", "Ticket updated in real-time.");
            });
          }
        } catch (e) {}
      });

      async function loadAdminDashboard() {
        try {
          const servicesRes = await fetch(
            `${BASE_URL}/api/queue/services/detailed`,
            {
              credentials: "include",
            }
          );
          services = (await servicesRes.json()).services || [];
          updateServiceFilter();

          const summaryRes = await fetch(
            `${BASE_URL}/api/queue/statistics/summary`,
            {
              credentials: "include",
            }
          );
          summary = await summaryRes.json();
          renderSummary(summary);

          const ticketsRes = await fetch(`${BASE_URL}/api/tickets/all`, {
            credentials: "include",
          });
          tickets = (await ticketsRes.json()).tickets || [];
          renderTickets(tickets);
        } catch (error) {
          showAlert(
            "danger",
            "Failed to load admin dashboard: " + error.message
          );
        }
      }

      function renderSummary(summary) {
        const row = document.getElementById("summaryRow");
        row.innerHTML = `
        <div class="col-md-3 mb-3">
          <div class="summary-card">
            <div class="text-primary"><i class="fas fa-users fa-2x"></i></div>
            <h2>${summary.total_waiting ?? "--"}</h2>
            <small>Currently Waiting</small>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="summary-card">
            <div class="text-success"><i class="fas fa-check-circle fa-2x"></i></div>
            <h2>${summary.total_daily_tickets ?? "--"}</h2>
            <small>Tickets Today</small>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="summary-card">
            <div class="text-warning"><i class="fas fa-clock fa-2x"></i></div>
            <h2>${Math.round(summary.overall_avg_service_time ?? 0)} min</h2>
            <small>Avg. Service Time</small>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="summary-card">
            <div class="text-info"><i class="fas fa-list fa-2x"></i></div>
            <h2>${summary.total_services ?? "--"}</h2>
            <small>Services</small>
          </div>
        </div>
      `;
      }

      function updateServiceFilter() {
        const select = document.getElementById("filterService");
        const current = select.value;
        select.innerHTML =
          `<option value="">All Services</option>` +
          services
            .map((s) => `<option value="${s.name}">${s.name}</option>`)
            .join("");
        select.value = current;
      }

      function renderTickets(ticketList) {
        const tbody = document.getElementById("ticketTableBody");
        if (!ticketList || ticketList.length === 0) {
          tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              <i class="fas fa-ticket-alt fa-2x mb-2"></i>
              <br>No tickets at this time.
            </td>
          </tr>
        `;
          return;
        }

        const filtered = applyFilters(ticketList);
        tbody.innerHTML = filtered
          .map(
            (ticket) => `
        <tr>
          <td>${ticket.ticketNumber || ticket.id}</td>
          <td>${ticket.user_name || ticket.studentName || "--"}</td>
          <td>${ticket.studentCode || ticket.userCode || "--"}</td>
          <td>${
            ticket.service_name || ticket.serviceType || ticket.serviceId
          }</td>
          <td>${ticket.position}</td>
          <td>
            <span class="badge status-badge bg-${statusColor(ticket.status)}">
              ${ticket.status}
            </span>
          </td>
          <td>${formatTime(ticket.createdAt)}</td>
          <td>${formatTime(ticket.calledAt)}</td>
          <td>${formatTime(ticket.completedAt)}</td>
        </tr>
      `
          )
          .join("");
      }

      function statusColor(status) {
        switch ((status || "").toUpperCase()) {
          case "WAITING":
            return "secondary";
          case "CALLED":
            return "primary";
          case "IN_PROGRESS":
            return "info";
          case "COMPLETED":
            return "success";
          case "CANCELLED":
            return "danger";
          default:
            return "light";
        }
      }
      function formatTime(time) {
        if (!time) return "--";
        return new Date(time).toLocaleString();
      }

      function filterTickets() {
        renderTickets(tickets);
      }

      function applyFilters(list) {
        const serviceName = document.getElementById("filterService").value;
        const status = document.getElementById("filterStatus").value;
        const search = document
          .getElementById("filterSearch")
          .value.trim()
          .toLowerCase();
        return list.filter((ticket) => {
          let matches = true;
          if (
            serviceName &&
            !(
              ticket.service_name ||
              ticket.serviceType ||
              ticket.serviceId ||
              ""
            )
              .toLowerCase()
              .includes(serviceName.toLowerCase())
          )
            matches = false;
          if (
            status &&
            (ticket.status || "").toUpperCase() !== status.toUpperCase()
          )
            matches = false;
          if (
            search &&
            !(
              (ticket.ticketNumber || ticket.id || "")
                .toLowerCase()
                .includes(search) ||
              (ticket.user_name || ticket.studentName || "")
                .toLowerCase()
                .includes(search) ||
              (ticket.studentCode || ticket.userCode || "")
                .toLowerCase()
                .includes(search)
            )
          )
            matches = false;
          return matches;
        });
      }

      function showAlert(type, message, duration = 3500) {
        const alertContainer = document.getElementById("alertContainer");
        const alertId = "alert_" + Date.now();
        const icons = {
          success: "check-circle",
          danger: "exclamation-triangle",
          warning: "exclamation-circle",
          info: "info-circle",
        };
        const alertHTML = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
          <i class="fas fa-${icons[type] || "info-circle"} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
        alertContainer.insertAdjacentHTML("beforeend", alertHTML);
        setTimeout(() => {
          const alertElement = document.getElementById(alertId);
          if (alertElement) alertElement.remove();
        }, duration);
      }

      async function refreshData() {
        showAlert("info", "Refreshing data...");
        await loadAdminDashboard();
      }

      function logout() {
        fetch(`${BASE_URL}/api/auth/logout`, {
          method: "POST",
          credentials: "include",
        }).finally(() => (window.location.href = "./adminLogin.html"));
      }

      document.addEventListener("DOMContentLoaded", () => {
      const table = document.getElementById("studentTable");
      const headers = table.querySelectorAll("th.sortable");
      const searchInput = document.getElementById("searchInput");
      
      let sortDirection = {};

      // Sorting
      headers.forEach((header, index) => {
        header.addEventListener("click", () => {
          const rows = Array.from(table.tBodies[0].rows);
          const isAsc = sortDirection[index] === "asc" ? false : true;
          sortDirection[index] = isAsc ? "asc" : "desc";

          rows.sort((a, b) => {
            let valA = a.cells[index].textContent.trim().toLowerCase();
            let valB = b.cells[index].textContent.trim().toLowerCase();

            if (!isNaN(Date.parse(valA)) && !isNaN(Date.parse(valB))) {
              return isAsc
                ? new Date(valA) - new Date(valB)
                : new Date(valB) - new Date(valA);
            } else if (!isNaN(valA) && !isNaN(valB)) {
              return isAsc ? valA - valB : valB - valA;
            } else {
              return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
          });

          table.tBodies[0].append(...rows);
        });
      });

      // Search
      searchInput.addEventListener("keyup", () => {
        const filter = searchInput.value.toLowerCase();
        const rows = table.tBodies[0].rows;

        for (let row of rows) {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(filter) ? "" : "none";
        }
      });
    });
    
    </script>
  </body>
</html>
